# Лабораторная работа 2
## Задание

1. Написать “плохой” CI/CD файл, который работает, но в нем есть не менее пяти “bad practices” по написанию CI/CD
2. Написать “хороший” CI/CD, в котором эти плохие практики исправлены
3. В Readme описать каждую из плохих практик в плохом файле, почему она плохая и как в хорошем она была исправлена, как исправление повлияло на результат

## Ход работы

Сначала были написаны 2 ```.yml``` файла [CI/CD с bad partices](https://github.com/dariapankova/clouds/blob/main/.github/workflows/bad_file.yml) и [CI/CD с good partices](https://github.com/dariapankova/clouds/blob/main/.github/workflows/good_file.yml).

Проведем сравнение этих файлов, описывая плохие практики и их исправление во втором файле.

**1. Запуск пайплайна при пуше в любой ветке**

Как можно увидеть в плохом файле пуш в любую ветку может развернуть изменение. 
```
on: push
```
В хорошем файле данная проблема была исправлена путем прописывания запуска только при пуше в ```.main```
```
on:
  push:
    branches:
      - main
```
**2. Отсутствие изоляции версии python**

В плохой версии файла используется системный python, что может привести к несовместимости версий.
```
- name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y python3-pip
```
В хорошей же версии была настроена изолированная среда python и задана конкретная версия (в нашем случае 3.9), это может помочь избежать несовместимости.
```
- name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
```
**3. Использование ```sudo``` для установки python**

В файле с плохими практиками пакеты python устанавливаются с использованием прав супер пользователя, а так как данные права могут выполнять произвольный код, это может в значительной мере навредить системе.
```
sudo apt-get update && sudo apt-get install -y python3-pip
```
В исправленой версии права супер пользователя не используются, поэтому шанс навредить системе снижается.
```
- name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
```
**4. Фиксированная версия зависимостей**

Для каждого из файлов был создан файл с зависимостями [requirements1.txt](https://github.com/dariapankova/clouds/blob/main/lab4/requirements1.txt) для файла с плохими практиками и [requirements2.txt](https://github.com/dariapankova/clouds/blob/main/lab4/requirements2.txt) для файла с хорошими практиками. Отличие в этих файлах не очень большое, но оно так же может привести к несовместимостям и ошибкам.

Так в [requirements1.txt](https://github.com/dariapankova/clouds/blob/main/lab4/requirements1.txt) мы видим, что фиксированную версию ```pytest```, и если она окажется устаревшей это приведет к ошибке.
```
pytest==6.2.4
```
Поэтому в [requirements2.txt](https://github.com/dariapankova/clouds/blob/main/lab4/requirements2.txt) была настроена гибкая версия ```pytest```, но не позднее ```6.2.4```, таким образом, если данная версия окажется устаревшей будет загружена более новая.
```
pytest>=6.2.4
```
**5. Отсутствие проверки при деплое**

При прописывании плохой практики при диплое мы пытались поработать с ключами SSH, но из-за выполнения данной работы на Windows так и не смогли до конца разобраться с этим, поэтому приняли решение просто выводить сообщения, которые будут сообщать нам о состоянии деплоя. Так в плохом файле отсутствует проверка тестов при деплое, то есть даже если тесты не пройдут, сообщение о деплое все равно выведется, поэтому есть риск задеплоить некорректный код.
```
- name: Deploy to production
        run: |
          echo "Вам чай с сахаром или с моими слезами?"
```
В хорошем же файле данная проблема была исправлена путем добавления условий по проверке тестов, так, при невыполнении хоть одного из них мы увидим сообщение о том, что деплой не состоялся, а в нашем случае, о том, что чай все-таки со слезами. Если же все тесты пройдены и деплой состоялся успешно, мы ссчастливые пойдем пить чай с сахаром.
```
- name: Deploy to production
        if: steps.test.outcome == 'success'
        run: |
          echo "Чай все-таки с сахаром"
          
      - name: Skip deployment
        if: steps.test.outcome != 'success'
        run: |
          echo "Тесты завершились с ошибкой, поэтому чай только со слезами"
```
![](https://sun9-80.userapi.com/impf/u3T7StgdqhkHcN1VP3FNI4Gl8s1EwUKqdL4laQ/_f6KGqoXjlY.jpg?size=1080x713&quality=96&sign=7c82d16686bf80ee2afe6513f38719e6&type=album)

